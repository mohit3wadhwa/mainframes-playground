IDENTIFICATION DIVISION.
PROGRAM-ID. IMSGNEX.
ENVIRONMENT DIVISION.
DATA DIVISION.
WORKING-STORAGE SECTION.
01  WS-STATUS-CODE      PIC X(2).
01  WS-SEG-KEY          PIC X(10).
01  WS-SEG-DATA         PIC X(40).
01  PCB-MASK.
    05 FILLER            PIC X(8).
    05 PCB-DBD-NAME      PIC X(8).
    05 PCB-SEG-LEVEL     PIC S9(4) COMP.
    05 PCB-STATUS        PIC X(2).
    05 FILLER            PIC X(14).
    05 PCB-DBD-NAME2     PIC X(8).
LINKAGE SECTION.
01  IO-PCB        PIC X(80).
01  DB-PCB        PIC X(80).
01  SSA-AREA      PIC X(20).
01  SEGMENT-AREA.
    05 SEG-KEY    PIC X(10).
    05 SEG-DATA   PIC X(40).
PROCEDURE DIVISION USING IO-PCB DB-PCB.
MAIN-SECTION.
    MOVE ' ' TO SEGMENT-AREA.
    MOVE ' ' TO SSA-AREA.
*   INITIAL GU TO ROOT SEGMENT
    CALL 'CBLTDLI' USING 'GU '
                         DB-PCB
                         SEGMENT-AREA
                         SSA-AREA.
    MOVE PCB-STATUS OF PCB-MASK TO WS-STATUS-CODE.
    IF WS-STATUS-CODE NOT = '  '
       DISPLAY 'IMS GU FAILED, STATUS=' WS-STATUS-CODE
       GO TO END-PGM
    END-IF.
    MOVE SEG-KEY   TO WS-SEG-KEY.
    MOVE SEG-DATA  TO WS-SEG-DATA.
    DISPLAY 'FIRST SEGMENT KEY : ' WS-SEG-KEY.
    DISPLAY 'FIRST SEGMENT DATA: ' WS-SEG-DATA.
*   GN LOOP TO READ NEXT SEGMENTS
    PERFORM UNTIL WS-STATUS-CODE NOT = '  '
       CALL 'CBLTDLI' USING 'GN '
                            DB-PCB
                            SEGMENT-AREA
                            SSA-AREA
       MOVE PCB-STATUS OF PCB-MASK TO WS-STATUS-CODE
       IF WS-STATUS-CODE = '  '
          MOVE SEG-KEY  TO WS-SEG-KEY
          MOVE SEG-DATA TO WS-SEG-DATA
          DISPLAY 'NEXT SEGMENT KEY : ' WS-SEG-KEY
          DISPLAY 'NEXT SEGMENT DATA: ' WS-SEG-DATA
       END-IF
    END-PERFORM.
END-PGM.
    STOP RUN.
